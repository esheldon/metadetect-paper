\documentclass[fleqn,useAMS,usenatbib]{mnras}
%=====================================================================
% CUSTOM: PACKAGES, MACROS & SETTINGS
%=====================================================================
% packages for figures
\usepackage{graphicx,todonotes}

% packages for symbols
\usepackage{latexsym,amssymb}

% AMS-LaTeX package for e.g. subequations
\usepackage{amsmath,morefloats}
\usepackage{natbib,graphicx,amsmath,subfigure,color}

\topmargin-1cm

\graphicspath{{figures/}}

\newcommand\notedo[1]{\todo[color=yellow, inline, size=\small]{To do:#1}}
\newcommand\notewrite[1]{\todo[color=orange, inline, size=\small]{To write: #1}}
\newcommand\noteask[1]{\todo[color=cyan, inline, size=\small]{To ask: #1}}
\newcommand\notecontrib[1]{\todo[color=green, inline, size=\small]{Contributors: #1}}
\newcommand\ess[1]{\todo[color=orange, inline, size=\small]{Erin: #1}}

\newcommand{\vecg}{\mbox{\boldmath $g$}}
\newcommand{\vece}{\mbox{\boldmath $e$}}
\newcommand{\veck}{\mbox{\boldmath $k$}}
\newcommand{\vecQ}{\mbox{\boldmath $Q$}}
\newcommand{\vecF}{\mbox{\boldmath $F$}}
\newcommand{\vecD}{\mbox{\boldmath $D$}}
\newcommand{\matR}{\mbox{$\bf R$}}
\newcommand{\matC}{\mbox{$\bf C$}}
\newcommand{\bnab}{\boldsymbol{\nabla}}
\newcommand{\bnabg}{\boldsymbol{\nabla_g}}
\newcommand{\galsim}{\texttt{GALSIM}}
\newcommand{\ngmix}{\texttt{ngmix}}
\newcommand{\nnsim}{\texttt{nsim}}
\newcommand{\snr}{$S/N$}
\newcommand{\sn}{$S/N$}
\newcommand{\coadd}{{\rm coadd}}
\newcommand{\desreq}{$4\times 10^{-3}$}
\newcommand{\lsstreq}{$2\times 10^{-3}$}

\newcommand{\mcal}{\textsc{metacalibration}}
\newcommand{\mdet}{\textsc{metadetection}}
\newcommand{\Mcalshort}{\textsc{metacal}}
\newcommand{\Mcal}{\textsc{Metacalibration}}
\newcommand{\vest}{\mbox{\boldmath $e$}}
\newcommand{\est}{e}
\newcommand{\mcalR}{\mbox{\boldmath $R$}}
\newcommand{\mcalRS}{\mbox{\boldmath $R_S$}}
\newcommand{\gest}{\mbox{\boldmath $\hat \gamma$}}
\newcommand{\vecgam}{\mbox{\boldmath $\gamma$}}

\newcommand{\bfd}{\textsc{BFD}}

\title[Metadetection]{Mitigating Shear-dependent Detection Biases with \Mcal}

\author[Sheldon et~al.]{Erin Sheldon$^1$, Matthew R. Becker$^2$,
Niall MacCrann$^{3,4}$, Michael Jarvis$^5$
  \\$^1$Brookhaven National Laboratory, Bldg. 510, Upton, NY 11973, USA
  \\$^2$High Energy Physics Division, Argonne National Laboratory , Lemont, IL 60439, USA
  \\$^3$Center for Cosmology and Astro-Particle Physics, The Ohio State University, Columbus, OH 43210, USA
  \\$^4$Department of Physics, The Ohio State University, Columbus, OH 43210, USA
  \\$^5$Department of Physics and Astronomy, University of Pennsylvania, Philadelphia, PA 19104, USA
}

\begin{document}
\date{Draft \today}
\maketitle

\begin{abstract}

\Mcal\ is a new technique for measuring weak gravitational lensing shear that
is unbiased for isolated galaxy images.  In this work we test the \mcal\ method
with overlapping, or ``blended'' galaxy images.  Using standard \mcal\ we find
a significant shear calibration bias when objects overlap. This bias is a few
percent for galaxy densities relevant for current surveys, and increases to
tens of percent for future surveys.  This bias is due to shear-dependent
detection rather than blending itself; if detection is shear independent, no
de-blending of images is needed, in principle.  We demonstrate that
shear-dependent detection biases are accurately removed when including
detection in the \mcal\ process.

\end{abstract}

\section{Introduction}


Recently introduced methods for the estimation of weak gravitational lensing
shear promise to provide calibration at the 0.1\% level, adequate for the
requirements of future weak lensing surveys.  Two methods that have
demonstrated sufficient accuracy without the use of calibration from
simulations, and without any compromise of precision, are the \bfd\ method
\citep{BernBFD2016} and the \mcal\ method \citep{HuffMcal2017,SheldonMcal2017}.
The tests of these methods, while stringent, did not include an important
aspect of the real universe: the images of objects overlap on the sky. In this
work we test \mcal\ in the presence of blending, and demonstrate that there is
a bias associated with shear-dependent detection.  We introduce an improvement
to the method that naturally accounts for this shear-dependent detection bias.

Proper accounting for blending is crucial for obtaining accurate redshifts
distributions, which are required to interpret the lensing signal (XXX good
citation)?  From a pure shear measurement point of view, blending will also
produce biased ellipticity measurements, and increase the variance of the
measured ellipticities \citep{DawsonBlending2016}.

A method such as \mcal\ can accurately calibrate ellipticity biases associated
with blending.  More problematic for shear calibration is the dependence of the
detection on shear.  Because the shear transformation is a simple mapping in
the weak shear regime, and the mapping preserves surface brightness
\citep{SchneiderBook92}, detection need not be shear dependent.  For example, a
detection algorithm that simply identifies connected regions above a
threshold as a single object will not in principle be shear dependent. However,
if the image is smeared by a point-spread-function (PSF), due to the atmosphere
and detector, the overlap of objects does depend on shear, because the PSF
convolution occurs after the shear mapping.  This effect is demonstrated in
figure \ref{fig:toy}.  In that case the simple threshold detection method
mentioned above will manifest a shear-dependent detection bias.

\begin{figure*}
    %\includegraphics[width=\textwidth]{figures/toy.pdf}
    \includegraphics[width=\textwidth]{figures/toy.png}

    \caption{ Toy example of shear-dependent detection in the presence of a
    PSF.  In panel (a) two objects are present, convolved by a PSF with no
    shear.  Contours represent constant brightness.  In panel (b) the objects
    are shared by a shear $(0.0, 0.1)$ {\em after} the PSF convolution.
    Contours are the same as panel (a).  In this case the inner contours for
    the two objects overlap before and after application of the shear.  This is
    a general property of the shear transformation in the weak regime.   In
    panel (c) the shear is applied {\em before} the PSF convolution, which
    mimics real sky images.  In this case the inner contours do not overlap
    after shearing.  For case (c) a detection algorithm that identified
    connected regions above a threshold as a single object would manifest a
    shear-dependent detection bias.  \label{fig:toy} }

\end{figure*}

Common detection schemes in use today, such at those in Source Extractor
\citep{Bertin96} and the HST/LSST pipelines \citep{BoschHSC2018,BoschLSST2018}
are based on thesholding, similar to the simple approach described above but
differing in complexity and efficiency.  Thus we would expect their detection
to also manifest shear dependence.

Any shear-dependent measurement effects can in principle be taken into account
within the \mcal\ formalism.  The implementations presented in
\cite{HuffMcal2017} and \cite{SheldonMcal2017} work by applying artificial
shears to small postage stamp images associated with previous detections.  As
we will demonstrate, detection effects can also be incorporated by instead
shearing larger images and re-running the detection phase on each of the
sheared images. There are number of technical challenges associated with this
\mcal\ implementation, which we will address in turn.

The paper is laid out as follows.... blah blah.


\section{\textsc{METACALIBRATION}}

blah

\section{Simulations}

\begin{figure*}
    \includegraphics[width=0.9\columnwidth]{figures/des-rgb-000000-crop.png}
    \includegraphics[width=0.9\columnwidth]{figures/lsst-rgb-000009-crop.png}

    \caption{Example images from the DES (left) and LSST (right) simulations.  \label{fig:simimages} }

\end{figure*}


\subsection{Galaxy Pairs}

\subsection{Simulations with Representative Galaxy Density and Noise}

\section{Shear-dependent Detection Biases}

\subsection{Bias in Simulations of Galaxy Pairs}

\begin{figure}
    \includegraphics[width=\columnwidth]{figures/pairs-mc-bdkpair.pdf}

\end{figure}
Erin's pair tests

\subsection{Bias in Simulations with Representative Galaxy Density and Noise}

Erin's tests with WeakLensingDeblending and Matt's tests

\begin{table}
    \centering
    \begin{tabular}{|l|l|c|c|}
        \hline
        Sim & Method         & \snr\ Cut & m             \\
        \hline
        \hline
        DES & MOF+metacal    & \snr$ > 10$ & $-0.016 \pm 0.003$  \\
        DES & MOF+metacal    & \snr$ > 15$ & $-0.038 \pm 0.003$  \\
        DES & MOF+metacal    & \snr$ > 20$ & $-0.053 \pm 0.003$  \\
        \hline
        LSST  & MOF+metacal    & \snr$ > 10$ & $-0.131 \pm 0.005$  \\
        LSST  & MOF+metacal    & \snr$ > 15$ & $-0.124 \pm 0.005$  \\
        LSST  & MOF+metacal    & \snr$ > 20$ & $-0.149 \pm 0.005$  \\
        \hline


    \end{tabular}
    
    \caption{
            Bias for standard \mcal\ with MOF deblending in simulations with
            realistic galaxy size, flux and noise.  In all cases a cut of
            $T/T_{PSF} > 0.5$ was also applied.  \ess{numbers are placeholders,
            need to run regular MOF+metacal on descwl sims}
            \label{tab:mcal:deblending}
    }

\end{table}


\section{Mitigating Shear-dependent Detection Biases with \textsc{METACALIBRATION}}
blah

\subsection{Results for Simulated Galaxy Pairs}

Erin's results with pairs.  Discuss results in the figure.

\subsection{Results for Simulations with Representative Galaxy Density and Noise}
\label{sec:res:constpsf}

Erin's results with WeakLensingDeblending and Matt's tests without
psf variation or masking

\begin{table}
    \centering
    \begin{tabular}{|l|l|c|c|}
        \hline
        Sim & Method         & \snr\ Cut & m             \\
        \hline
        \hline
        DES & \mdet+moments & \snr$ > 10$ & $-0.0010 \pm 0.0013$  \\
        DES & \mdet+moments & \snr$ > 15$ & $+0.0000 \pm 0.0013$  \\
        DES & \mdet+moments & \snr$ > 20$ & $+0.0002 \pm 0.0013$  \\
        \hline
        LSST  & \mdet+moments & \snr$ > 10$ & $-0.0027 \pm 0.0011$  \\
        LSST  & \mdet+moments & \snr$ > 15$ & $-0.0018 \pm 0.0011$  \\
        LSST  & \mdet+moments & \snr$ > 20$ & $+0.0001 \pm 0.0011$  \\
        \hline


    \end{tabular}
    
    \caption{
        Bias for \mcal, including detection in the process (a.k.a. \mdet).  These
        simulations have no PSF variation or masking.  No
        deblending was performed, and simple weighted moments were used
        without PSF correction.  In all cases a cut of $T/T_{PSF} > 0.5$ was
        also applied.  \ess{LSST needs to be redone with better
        psf handling.  } \label{tab:mdet:constpsf}
    }

\end{table}



\subsection{Results for Simulations with Realistic Masking and PSF Variation}
\label{sec:res:varpsf}

Matt's stuff with the full glory.  If all are equally unbiased, we can remove
secion \ref{sec:res:constpsf}

\begin{table}
    \centering
    \begin{tabular}{|l|l|c|c|}
        \hline
        Sim & Method         & \snr\ Cut & m             \\
        \hline
        \hline
        DES & \mdet+moments & \snr$ > 10$ & $-0.0010 \pm 0.0013$  \\
        DES & \mdet+moments & \snr$ > 15$ & $+0.0000 \pm 0.0013$  \\
        DES & \mdet+moments & \snr$ > 20$ & $+0.0002 \pm 0.0013$  \\
        \hline
        LSST  & \mdet+moments & \snr$ > 10$ & $-0.0027 \pm 0.0011$  \\
        LSST  & \mdet+moments & \snr$ > 15$ & $-0.0018 \pm 0.0011$  \\
        LSST  & \mdet+moments & \snr$ > 20$ & $+0.0001 \pm 0.0011$  \\
        \hline


    \end{tabular}
    
    \caption{
        Same as table \ref{tab:mdet:constpsf} but with realistic masking and
        spatial PSF variation.  \ess{numbers are placeholders} \label{tab:mdet:varpsf}
    }

\end{table}


\section{Summary}
blah

\bibliographystyle{mnras}
\bibliography{references}

\end{document}
